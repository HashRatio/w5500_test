/*
 * Author: Minux
 * Author: Xiangfu Liu <xiangfu@openmobilefree.net>
 * Bitcoin:	1CanaaniJzgps8EV6Sfmpb7T8RutpaeyFn
 *
 * This is free and unencumbered software released into the public domain.
 * For details see the UNLICENSE file at the root of the source tree.
 */

#include <stdbool.h>
#include <stdint.h>
#include <stddef.h>
//#include <stdio.h>
#include "minilibc.h"

#include "system_config.h"
#include "defines.h"
#include "io.h"
#include "intr.h"
#include "uart.h"
#include "miner.h"
#include "sha256.h"
#include "twipwm.h"
#include "shifter.h"
#include "protocol.h"
#include "crc.h"
#include "miner.h"
#include "hexdump.c"
#include "utils.h"
#include "spi.h"
#include "w5500.h"
#include "socket.h"
#include "dns.h"
#include "jsmn.h"
#include "stratum.h"
#include "pub_var.h"

#define MM_BUF_NUM  3
#define IDLE_TIME	60	/* Seconds */

#define CH 0

//int8 buffer[BUFFER_SIZE];/*定义一个2KB的缓存*/
uint8 mac[6]={0x00,0x08,0xDC,0x01,0x02,0x03};/*定义Mac变量*/
uint8 ip[4]={192,168,2,200};/*定义Ip变量*/
uint8 sn[4]={255,255,255,0};/*定义Subnet变量*/
uint8 gw[4]={192,168,2,1};/*定义Gateway变量*/
uint8 dip[4]={192,168,2,116};
uint8 DEFAULT_DNS[4] = {192,168,2,1};
uint8 RIP[4];
uint8 DOMAIN[] = "stratum.f2pool.com";

int8 g_new_stratum;
uint8 coinbase[128] = {
0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0xff,0x20,0x02,0x08,0x62,0x06,0x2f,0x50,
0x32,0x53,0x48,0x2f,0x04,0xb8,0x86,0x4e,0x50,0x08,0x55,0x55,0x55,0x55,0xaa,0xaa,
0xaa,0xaa,0x07,0x2f,0x73,0x6c,0x75,0x73,0x68,0x2f,0x00,0x00,0x00,0x00,0x01,0x00,
0xf2,0x05,0x2a,0x01,0x00,0x00,0x00,0x19,0x76,0xa9,0x14,0xd2,0x3f,0xcd,0xf8,0x6f,
0x7e,0x75,0x6a,0x64,0xa7,0xa9,0x68,0x8e,0xf9,0x90,0x33,0x27,0x04,0x8e,0xd9,0x88,
0xac,0x00,0x00,0x00,0x00};

uint8 merkle_branch[160] = {
0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,
0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,

0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,
0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,

0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,
0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,

0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,
0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,

0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,
0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55
};

void W5500_Init(void)
{
	iinchip_hw_init();
	setSHAR(mac);/*配置Mac地址*/
	setSIPR(ip);/*配置Ip地址*/
	setSUBR(sn);/*配置子网掩码*/
	setGAR(gw);/*配置默认网关*/
}


int main(int argv,char * * argc)
{	
	
	irq_setmask(0);
	irq_enable(1);
	
	uart_init();
	uart1_init();
	
	uart_write(0x55);
	debug32("Init.\n");
	
	uint8 txsize[8] = {2,2,2,2,2,2,2,2};/*给每个socket配置一个2KB的发送内存*/
	uint8 rxsize[8] = {2,2,2,2,2,2,2,2};/*给每个socket配置一个2KB的接收内存*/
	
	W5500_Init();
	
	setRTR(2000);/*设置溢出时间值*/
	setRCR(3);/*设置最大重新发送次数*/
	sysinit(txsize, rxsize);/*初始化8个socket*/
	
	mm_work_ptr = &g_mm_works[0];
	/*
	memcpy(mm_work_ptr->coinbase,coinbase,117);
	mm_work_ptr->coinbase_len = 117;
	
	mm_work_ptr->nonce2_offset = 62;
	
	memcpy(mm_work_ptr->merkles,merkle_branch,160);
	mm_work_ptr->nmerkles = 5;
	mm_work_ptr->merkle_offset = 36;
	miner_gen_nonce2_work(mm_work_ptr, 0xaaaaaaaa, &g_works[0]);*/
	
	if(do_dns(DEFAULT_DNS,DOMAIN,RIP))
		debug32("parse ok.\n");
	else
		debug32("parse failed.\n");
    connect_poll(RIP,3333);
	send_subscribe();
	send_authorize();
	while(1){
		recv_stratum(&g_mm_works[0]);
		if(g_new_stratum){
			//miner_gen_nonce2_work(mm_work_ptr, 0, &g_works[0]);
			g_new_stratum = 0;
		}
	}
	
	return 0;
}

